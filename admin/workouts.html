<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Workouts | Eatrofit Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <div class="container py-5">
    <div class="mb-3">
      <label for="scheduleDate" class="form-label">Schedule Workout (Demo):</label>
      <input type="text" id="scheduleDate" class="form-control" style="width:200px" placeholder="Select date">
    </div>
    <h2 class="mb-4">Workout Management</h2>
    <table class="table table-bordered table-striped" id="workoutsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Level</th>
          <th>Duration</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
  fetch('../api/admin_get_workouts.php')
      .then(res => res.json())
      .then(data => {
        const tbody = document.querySelector('#workoutsTable tbody');
        data.workouts.forEach(w => {
          const tr = document.createElement('tr');
          // ID
          const tdId = document.createElement('td');
          tdId.textContent = w.id;
          tr.appendChild(tdId);
          // Name
          const tdName = document.createElement('td');
          tdName.textContent = w.name;
          tr.appendChild(tdName);
          // Level
          const tdLevel = document.createElement('td');
          tdLevel.textContent = w.level;
          tr.appendChild(tdLevel);
          // Duration
          const tdDuration = document.createElement('td');
          tdDuration.textContent = w.duration_min + ' min';
          tr.appendChild(tdDuration);
          // Actions
          const tdActions = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-danger btn-sm delete-workout';
          delBtn.innerHTML = "<i class='bi bi-trash'></i> Delete";
          tdActions.appendChild(delBtn);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
        // Initialize DataTable and Flatpickr after data is loaded
        $(document).ready(function() {
          $('#workoutsTable').DataTable();
          flatpickr('#scheduleDate', {dateFormat: 'Y-m-d'});
          // SweetAlert2 for delete confirmation and API call
          $('#workoutsTable').on('click', '.delete-workout', function() {
              const row = $(this).closest('tr');
              const workoutId = row.find('td').eq(0).text();
              Swal.fire({
                title: 'Are you sure?',
                text: 'This will permanently delete the workout.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete!',
                cancelButtonText: 'Cancel',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                  Swal.getConfirmButton().disabled = false;
                }
              }).then((result) => {
                if (result.isConfirmed) {
                  Swal.getConfirmButton().disabled = true;
                  fetch('../api/admin_delete_workout.php', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: workoutId })
                  })
                  .then(res => res.json())
                  .then(resp => {
                    if (resp.success) {
                      Swal.fire('Deleted!', 'Workout deleted.', 'success');
                      $('#workoutsTable').DataTable().row(row).remove().draw();
                    } else {
                      Swal.fire('Error', resp.error || 'Delete failed', 'error');
                    }
                  })
                  .catch(() => {
                    Swal.fire('Error', 'Delete failed', 'error');
                  });
                }
              });
          });
        });
      });
  </script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- jQuery, DataTables already included above -->
</body>
</html>
